// schema.prisma

// 1. Configuración de la Base de Datos
// Usamos PostgreSQL como referencia.
datasource db {
  provider = "postgresql"
  // ¡IMPORTANTE! Reemplaza esto con tu URL de conexión real
  url      = env("DATABASE_URL")
}

// 2. Configuración del Cliente de Prisma
generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

// 3. Modelos de la Base de Datos

// Modelo de Usuarios (users) - Mantiene ID Int para eficiencia interna
model User {
  id                   Int      @id @default(autoincrement()) @map("user_id")
  username             String   @unique @db.VarChar(50)
  email                String   @unique @db.VarChar(100)

  // Seguridad y Autenticación
  passwordHash         String   @map("password_hash") @db.VarChar(255)
  twoFactorSecret      String?  @map("two_factor_secret") @db.VarChar(255)
  is2faEnabled         Boolean  @default(false) @map("is_2fa_enabled")

  // Recuperación
  resetPasswordToken   String?  @map("reset_password_token")
  resetPasswordExpires DateTime? @map("reset_password_expires")

  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @default(now()) @map("updated_at")

  // Relaciones
  groupsCreated   Group[]  @relation("GroupCreator")
  groupMemberships GroupMember[]
  messagesSent    Message[]

  @@map("users")
}

// Modelo de Grupos (groups) - IMPLEMENTACIÓN DEL ID ALFANUMÉRICO DE 8 CARACTERES
model Group {
  // ID ALFANUMÉRICO DE 8 CARACTERES
  id                String   @id @unique @db.Char(8) @map("group_id") // ID generado por la aplicación
  groupName         String   @map("group_name") @db.VarChar(100)

  // Relación con el creador
  creatorId         Int      @map("creator_id")
  creator           User     @relation("GroupCreator", fields: [creatorId], references: [id])

  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @default(now()) @map("updated_at")

  // Llave Maestra de Enigma
  enigmaMasterKey   String   @map("enigma_master_key") @db.Text

  // Relaciones
  members           GroupMember[]
  messages          Message[]

  @@map("groups")
}

// Modelo de Pertenencia a Grupos (group_members)
// Las claves foráneas deben reflejar el nuevo tipo de ID (String) para groupId
model GroupMember {
  // Claves Primarias y Foráneas
  groupId String @map("group_id") // Ahora es String
  userId  Int    @map("user_id")

  // Definición de la Clave Primaria Compuesta
  @@id([groupId, userId])

  // Relación con el Grupo (referencia al String id)
  group   Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  // Relación con el Usuario
  user    User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Rol del Miembro
  role    GroupRole @default(MEMBER)

  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @default(now()) @map("updated_at")

  @@map("group_members")
}

// Modelo de Mensajes (messages) - Mantiene ID Int
model Message {
  id         Int      @id @default(autoincrement()) @map("message_id")

  // Claves Foráneas: groupId es ahora String
  groupId    String   @map("group_id")
  group      Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  senderId   Int?     @map("sender_id")
  sender     User?    @relation(fields: [senderId], references: [id], onDelete: SetNull)

  // Contenido Cifrado
  ciphertext String   @map("ciphertext") @db.Text

  sentAt     DateTime @default(now()) @map("sent_at")
  updatedAt         DateTime @default(now()) @map("updated_at")

  @@map("messages")
}

// 4. Tipo ENUM para Roles
enum GroupRole {
  ADMIN
  MEMBER

  @@map("group_role")
}
